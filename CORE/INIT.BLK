DECIMAL                                                                                                                         ( ********************************************************** )  ( *  FORTH kernal extensions                               * )  ( *  software by Nick Porcino and Don Palmer               * )  ( ********************************************************** )                                                                  : ."                                                              34 STATE @ IF                                                       COMPILE <."> WORD HERE C@ 1+ ALLOT HERE EVEN DP !           ELSE WORD HERE COUNT TYPE THEN ; IMMEDIATE                                                                                    : ," ( compiles a headerless string )                             34 WORD HERE COUNT 1+ ALLOT DROP ;                                                                                             ( ********************************************************* )   ( * GEMDOS extensions                                     * )   ( ********************************************************* )                                                                  VARIABLE _OLDMARK                                               VARIABLE _BLSTART  VARIABLE _BLEND  VARIABLE _BLKLEN            VARIABLE _IW  VARIABLE _CW                                                                                                      VARIABLE _HANDLE   VARIABLE _FONT                                                                                               ( Glomps the next word in the input stream, returns true           if there was a next word. )                                  : GET-WORD                                                          BL WORD HERE COUNT DUP 1 <> ;                                                                                               : NEWFILE ( string --- handle )                                   $>C$ >R 0 L>W R> 60 L>W 4 GEMDOS ;                                                                                            : WRITE ( handle buffer bytes --- handle bytesWritten )            ROT DUP >R L>W 64 L>W 5 GEMDOS R> SWAP ;                                                                                     : READ  ( handle buffer bytes --- handle bytesRead )               ROT DUP >R L>W 63 L>W 5 GEMDOS R> SWAP ;                                                                                     CREATE _ERRMSG                                                     ," Unknown error"                                               ," General error"                                               ," Drive not ready"                                             ," Unknown command"                                             ," CRC error"                                                   ," Bad request"                                                 ," Seek error"                                                  ," Unknown media"                                               ," Sector not found"                                            ," Out of paper"                                                ," Write fault"                                                 ," Read fault"                                                  ," Write protected"     ( 160 )                                 ," Media changed"       ( 176 )                                 ," Unknown device"      ( 190 )                                 ," Bad sector"          ( 205 )                                 ," Request other disk"  ( 216 )                                 ," Invalid function"    ( 235 )                                 ," File not found"      ( 252 )                                 ," Path not found"      ( 267 )                                 ," Handle pool exhausted" ( 282 )                               ," Access denied"       ( 304 )                                 ," Invalid handle"      ( 318 )                                 ," Insufficient memory" ( 333 )                                 ," Invalid memory block" ( 353 )                                ," Invalid drive"       ( 374 )                                 ," No more files"       ( 388 )                                 ," Range error"         ( 402 )                                 ," GEMDOS internal error" ( 414 )                               ," Invalid file format"      ( 436 )                            ," Memory allocation failure" ( 456 )                                                                                        CREATE _OFF                                                       0 W, 14 W, 28 W, 44 W, 60 W, 70 W, 82 W, 93 W,  ( 0-7 )         107 W, 124 W, 137 W, 149 W, 14 W, 160 W, 176 W, 190 W, ( 8-15)  205 W, 216 W, 0 W, 0 W, 0 W, 0 W, 0 W, 0 W,     ( 16-23 )       0 W, 0 W, 0 W, 0 W, 0 W, 0 W, 0 W, 0 W,         ( 24-31 )       235 W, 252 W, 267 W, 282 W, 304 W, 318 W, 0 W, 333 W, ( 32-39)  353 W, 0 W, 0 W, 0 W, 0 W, 0 W, 374 W, 388 W,   ( 40-47 )       0 W, 0 W, 0 W, 0 W, 0 W, 0 W, 0 W, 0 W,         ( 48-55 )       0 W, 0 W, 0 W, 0 W, 0 W, 0 W, 0 W, 0 W,         ( 56-63 )       402 W, 414 W, 436 W, 456 W, 0 W,                ( 64-68 )                                                                     : ?DERROR ( n --- n )                                                  DUP 0< IF DUP NEGATE DUP                                        SPACE 42 DUP EMIT EMIT SPACE . SPACE                            2* _OFF + W@ _ERRMSG + COUNT TYPE CR THEN ;                                                                              VARIABLE _LOCAL  VARIABLE _LOCAL2                                                                                               : UNSQFILE ( --- )                                                HERE _LOCAL !   BUFFER _LOCAL2 !                                BEGIN                                                              _LOCAL @ 10 ENCLOSE     ( scan text for line feed or EOF )      _LOCAL2 @ _CW @ BLANKS ( fill next line with blanks )           _LOCAL +!        ( point to next character to be checked )      OVER - 1- >R     ( calc length of string between delims  )      +                ( addr of first nondelim to copy        )      _LOCAL2 @        ( addr to move to )                            R>               ( character count )                            CMOVE            ( copy the string )                                                                                            _CW @ _LOCAL2 +! ( increment dest address )                                                                                  _LOCAL @ C@ 0= _LOCAL2 @ ORG > OR                               UNTIL  ( loop until EOF, or buffer filled. )                                                                                    _LOCAL2 @ _TOTAL !                                                8 _X !  _Y 0! ( set up for editor )                           BUFFER _MARK ! ;                                                                                                              : GOGETIT ( ADDR N --- )                                             OPEN ?DERROR DUP                                                  0> IF                                                             HERE 2 L>W 1 XBIOS ( get address of screen )                    HERE - READ ( read the file in )                                ?DERROR DUP 0> IF >R CLOSE DROP R>                                HERE + 1+ 8 0 FILL ( mark end of file )                         78 DUP C/L !  _CW !  _IW 0!                                     UNSQFILE                                                        _BLEND 0!   _BLSTART 0!   _BLKLEN 0!                          ELSE DROP ."  Error during read." ABORT THEN                  ELSE DROP ."  Unable to open file." ABORT THEN ;                                                                         : ENTER                                                             GET-WORD IF GOGETIT ELSE ."  Syntax Error!" THEN ;                                                                          : SQFILE ( --- )                                                  BUFFER _LOCAL !  HERE _LOCAL2 !                                  _TOTAL @ BUFFER DO                                              I _LOCAL !                                                      _LOCAL @                                                        _CW @ -TRAILING  ( line of text sans trailing spaces )          DUP IF _LOCAL2 @ SWAP >R R@ CMOVE R> _LOCAL2 +!                 ELSE DROP DROP THEN                                             _LOCAL2 @ DUP 13 SWAP C! 10 SWAP 1+ C! 2 _LOCAL2 +!            _CW @ +LOOP ;                                                                                                                 : GOPUTIT                                                            NEWFILE ?DERROR DUP                                             0> IF                                                              SQFILE                                                          HERE _LOCAL2 @ HERE - WRITE                                       ?DERROR DROP CLOSE DROP                                    ELSE ."  Unable to open file." ABORT THEN ;                                                                                : SAVE ( string --- )                                              GET-WORD IF GOPUTIT ELSE ."  Syntax error" ABORT THEN ;                                                                      : A! ( abs_addr n --- ) SWAP ORG - SWAP ! ;                     : A@ ( addr --- abs_addr ) @ ORG + ;                            : A, ( abs_addr --- ) ORG - , ;                                                                                                 QUIT              ( *** END OF FILE *** )                                                                                                                                                       